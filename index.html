<body style="background:black;text-align:center;">
	<canvas id="c" >
<script>
	names=["Red","Blue"]
	
	tile=24
	gamestate=0;
	
	a = new Image()
	a.src="a.png"
	context=c.getContext("2d")
	context.imageSmoothingEnabled = false;
	c.width=context.width=720
	c.height=context.height=480
	map=[];
	
	
	truetimer=0;
	timer=0;
	setInterval(function(){
		switch(gamestate){
			case 0:
			context.fillStyle="black"
		context.fillRect(0,0,720,480)
		context.fillStyle = '#f00';
 context.font = 'italic bold 30px sans-serif';
 context.textBaseline = 'bottom';
 context.fillText('Space battle!', 50, 100);
			break;
			case 2:
			context.fillStyle="black"
		context.fillRect(0,0,720,480)
		context.fillStyle = winner;
 context.font = 'italic bold 30px sans-serif';
 context.textBaseline = 'bottom';
 context.fillText(winner +" wins!", 50, 100);
			break;
			case 1:
		truetimer+=0.5
		timer=Math.round(truetimer)
		context.fillStyle="black"
		context.fillRect(0,0,720,480)

		
		for (i=0;i<30;i++){
			for(j=0;j<20;j++){
				switch(map[i][j]){
					case 0:
				if(currentPlayer==0){
					context.globalAlpha=Math.abs((10-timer+i+j)%20)/30+0.2
				}else{
					context.globalAlpha=Math.abs((10-timer-i+j)%20)/30+0.2
				}
				context.drawImage(a,0,(7*i+5*j+50)%(tile*2),tile,tile,i*24,j*24,24,24);
				context.globalAlpha=1
				break;
				case 1:
				context.drawImage(a,tile,0,tile,tile,i*24,j*24,24,24);
				break;
				case 2:
				context.drawImage(a,tile*4,tile*(timer%3),tile,tile,i*24,j*24,24,24);
				break;
				}
			}
		}
		
		context.drawImage(a,tile,tile,tile,tile,laser.x*24,laser.y*24,24,24);
		
		if(timer%4>2){
			context.drawImage(a,tile,2*tile,tile,tile,players[currentPlayer].x*24,players[currentPlayer].y*24,24,24);
		}
		players.forEach(function(x){
			context.save();
			context.translate(x.x*24+10,x.y*24+10);
			context.rotate(x.r);
			context.drawImage(a,tile*2+tile*x.id,tile*((x.id==currentPlayer)*(1+timer%2)),tile,tile,-10,-10,24,24);
			context.restore();
		});
		break;
		}
	},100)
	
	currentPlayer=0
	
	input=false;
	window.addEventListener("keydown",function(e){
		switch(gamestate){
			case 0:
			for (i=0;i<30;i++){
		map[i]=[];
			for(j=0;j<20;j++){
				map[i][j]=Math.random()<0.2?1:0;
				map[i][j]=Math.random()<0.01?2:map[i][j];
			}
	}
	players=[{x:5,y:10,id:0,r:Math.PI/2},{x:25,y:10,id:1,r:-Math.PI/2}];
	players.forEach(function(x){
		map[x.x][x.y]=0;
	})
	laser={x:100,y:100,vx:0,vy:0}
			gamestate=1;
			break;
			case 2:
			gamestate=0
			break;
			case 1:
		x=0;
		y=0;
		x=e.keyCode==37?x-1:x;
		x=e.keyCode==39?x+1:x;
		y=e.keyCode==38?y-1:y;
		y=e.keyCode==40?y+1:y;
		if(!input && !(x==0&&y==0)){
			input=true;
			movePlayer(x,y,currentPlayer);
		}
		if(!input&&e.keyCode==32){
			laser.x=players[currentPlayer].x;
			laser.y=players[currentPlayer].y;
			laser.vx=Math.sin(players[currentPlayer].r);
			laser.vy=-Math.cos(players[currentPlayer].r);
			input=true;
			moveProj();
		}
				break;
		}
	});
	
	function movePlayer(x,y,i){
		players[i].r=Math.atan2(y,x)+Math.PI/2;
		if(map[players[i].x+x]&&map[players[i].x+x][players[i].y+y]==0 && !(players[i].y+y==players[(i+1)%2].y&&players[i].x+x==players[(i+1)%2].x)){
			players[i].x+=x;
			players[i].y+=y;
			setTimeout(movePlayer,200,x,y,i);
		}else if(map[players[i].x+x]&&map[players[i].x+x][players[i].y+y]==2 ){
			gamestate=2;
			winner=names[(i+1)%2]
		}else {
			currentPlayer=(currentPlayer+1)%2
			setTimeout(function(){input=false;},100);
		}
	}
	
	function moveProj(){
		laser.x+=laser.vx;
		laser.y+=laser.vy;
		players.forEach(function(x){
		if(laser.y==x.y&&laser.x==x.x){
			winner=names[(x.id+1)%2]
			gamestate=2;
		}
		});
		if(map[laser.x]&&map[laser.x][laser.y]==0){
			setTimeout(moveProj,100);
		}else{
			if(map[laser.x]&&map[laser.x][laser.y]==1){
				map[laser.x][laser.y]=0;
			}
			laser.x=laser.y=100;
			laser.vx+=laser.vy=0;
			currentPlayer=(currentPlayer+1)%2
			setTimeout(function(){input=false;},100)
		}
	}
</script>